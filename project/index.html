<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head>
		<title>Inside Effects</title>
		<link href="style.css" rel="stylesheet" type="text/css" />
		<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
		<script type="text/javascript" src="util.js"></script>
		<script type="text/javascript" src="embed.js"></script>
		<script type="text/javascript" src="ohm.js"></script>
		<script type="text/ohm-js">
			Inside {
			  Exp    = Seq+                      -- seq
			  Seq    = Or  ";"                   -- seq

			  List   = LElm+ LExp                -- two
			         | LElm+                     -- end
			         | LExp                      -- one
				 |                           -- nul
			  LElm   = LExp ","                  -- elm
			  LExp   = Or                        -- exp

			  Hash   = HElm+ HExp                -- two
			         | HElm+                     -- end
			         | HExp                      -- one
				 |                           -- nul
			  HElm   = HExp ","                  -- elm
			  HExp   = ident ":" Or              -- exp

			  Or     = Or  "||" And              -- or
			         | And

			  And    = And "&&" Eq               -- and
			         | Eq

			  Eq     = Eq  "==" Cmp              -- eq
			         | Eq  "!=" Cmp              -- ne
			         | Cmp

			  Cmp    = Cmp ">"  Add              -- gt
			         | Cmp "<"  Add              -- lt
			         | Cmp ">=" Add              -- ge
			         | Cmp "<=" Add              -- le
			         | Add

			  Add    = Add "+"  Mul              -- add
			         | Add "-"  Mul              -- sub
			         | Mul

			  Mul    = Mul "*"  Pow              -- mul
			         | Mul "/"  Pow              -- div
			         | Mul "%"  Pow              -- mod
			         | Pow

			  Pow    = Pow "^"  Un               -- pow
			         | Un

			  Un     = "+" Un                    -- pos
			         | "-" Un                    -- neg
			         | "!" Un                    -- not
			         | Type

			  Type   = label Def+                -- args
			         | Call

			  Call   = Pri   Def+                -- args
			         | Def

			  Def    = "fun" ident* "->" Or      -- fun
			         | "set" ident  "="  Or      -- set
			         | "as"  ident*       ":" Or -- as
			         | "def" ident ident* ":" Or -- def
			         | "match" Or  "with" Case+  -- match
			         | Pri                       -- pri

			  Case   = "|" Or "->" Or            -- case

			  Pri    = "(" Or   ")"              -- paren
			         | "{" Exp  "}"              -- brace
			         | "[" List "]"              -- list
			         | "[" Hash "]"              -- hash
			         | Pri "(" ")"               -- call
			         | label                     -- type
			         | ident                     -- var
			         | number                    -- num
			         | string                    -- str

			  ident  = ~kword /[a-z_]/ alnum*

			  label  = /[A-Z]/  alnum*

			  number = digit* "." digit+        -- fract
			         | digit+                   -- whole

			  string = "\"" char* "\""

			  char   = escape
			         | ~"\"" ~"\n" _

			  escape = "\\x" hexDigit hexDigit                    -- hexEscape
			         | "\\u" hexDigit hexDigit hexDigit hexDigit  -- unicodeEscape
			         | "\\" _                                     -- escape

			  kword  = "match"
			         | "with"
			         | "fun"
			         | "as"
			         | "set"
			         | "def"
			}
		</script>
	</head>
	<body>
		<!--
		<h1>Basics</h1>
		<script src="lang.js">
			# Hello, World
			print ( "hello: " + 123 ) ;

			# Simple functions
			set num = 1;
			set inc = fun -> set num = num + 1;

			print ( "inc:  " + inc() ) ;
			print ( "inc:  " + inc() ) ;
			print ( "num:  " + num   ) ;
		</script>
		-->

		<h1>Types and arrays</h1>
		<script src="lang.js">
			print ( Foo             );
			print ( Foo 123         );
			print ( Foo (Bar 456)   );

			print [                 ];
			print [      1          ];
			print [      1,      2  ];
			print [      1,      2, ];

			print [ foo: 1          ];
			print [ foo: 1, bar: 2  ];
			print [ foo: 1, bar: 2, ];
		</script>

		<!--
		<h1>Records</h1>
		<script src="lang.js">
			# Hello, World
			print ( "hello: " + 123 ) ;

			# Simple functions
			set num = 1;
			set inc = fun -> set num = num + 1;

			print ( "inc:  " + inc() ) ;
			print ( "inc:  " + inc() ) ;
			print ( "num:  " + num   ) ;
		</script>
		-->

		<!--
		<h1>Recursion</h1>
		<script src="lang.js">
			set sum = fun n ->
				match n with
					| 0 -> 0
					| _ -> n + (sum (n-1));
			sum 5;
		</script>
		-->

		<!--
		<h1>Counters</h1>
		<script src="lang.js">
			set ctr = fun n ->
				fun -> set n = n + 1;
			set c1 = ctr 10;
			set c2 = ctr 20;

			print("c1: "+c1()+" -> "+c1()+" -> "+c1());
			print("c2: "+c2()+" -> "+c2()+" -> "+c2());
			print("c1: "+c1()+" -> "+c1()+" -> "+c1());
		</script>
		-->

		<!--
		<h1>Match</h1>
		<script src="lang.js">
			match None with
				| Some 0 -> print ("some: zero")
				| Some n -> print ("some: " + n)
				| None   -> print "none"
				| _      -> print "unknown";
		</script>
		-->

		<!--
		<h1>Iterators</h1>
		<script src="lang.js">
			def range lo hi:
				fun ->
					if (lo <= hi) {
						set out = lo;
						set lo  = lo+1;
						Some out;
					} None;

			def map iter body:
				fun ->
					match iter() with
						| Some x -> Some (body x)
						| None   -> None;

			def zip a b:
				fun ->
					match [a(), b()] with
						| [Some x, Some y] -> Some [x, y]
						| [None,   None  ] -> None;

			def foreach iter body:
				match iter() with
					| Some x -> { body x; foreach iter body; }
					| None   -> [];


			set nums = range 2 4;
			set dbls = map nums as item: item * 2;
			set both = zip nums dbls;

			foreach both as arr:
				match arr with
					| [x, y] -> print ("x="+x+", y="+y);

			foreach nums as num:
				print ("num: " + num);

			foreach dbls as dbl:
				print ("dbl: " + dbl);
		</script>
		-->

		<!--
		<h1>Thoughts</h1>
		<h2>Recursion</h2>
		<script src="embed.js?ft=inside,nu">
			set num   = 0;
			set count = fun ->
				if (num < 10)
					count();
				set num = num+1;
			count();
		</script>

		<h2>Conditionals</h2>
		<script src="embed.js?ft=inside,nu">
			# Conditionals
			set true = fun then else ->
				then();
			set false = fun then else ->
				else();
			set if = cond then else ->
				cond then else;
		</script>

		<h2>For Loops</h2>
		<script src="embed.js?ft=inside,nu">
			# Iterators - for each
			#    set tmp = range 0 2;
			#    tmp(); -> Some 0
			#    tmp(); -> Some 1
			#    tmp(); -> Some 2
			#    tmp(); -> None
			set range = fun lo hi ->
				set iter = fun ->
					set out = if (lo <= hi)
						( Some cur )
						( None     )
					set lo  = lo+1;
					out;

			set foreach = fun iter body ->
				match iter():
					Some x -> body(x);
					          foreach iter body;
					None   ->

			set fib = fun ->
				set a = 0;
				set b = 1;
				set iter = fun ->
					set o = a;
					set a = b;
					set b = o + b;
					Some o;

			foreach range(1,10) fun i ->
				print i
		</script>

		<h2>Iterators</h2>
		<script src="embed.js?ft=inside,nu">
			# Iterators - for loop
			set for = init cond step body state=null ->
				if cond(state)
					{ set state = body(state);
					  set next  = step(init);
					  for next cond step body state; }
					{ state; }

			while 0, <10, +1, +, 0
			while 0, {i|i<10}, {i|i+1}, {s,i|s+i}, 0
		</script>
		-->
	</body>
</html>
